@{
    ViewData["Title"] = "Nurse Details";
    string badgeClass = "bg-success"; 
    bool hasRating = Model.reviewsNumber > 0;// default

    if (hasRating)
    {
        if (Model.rating <= 2)
        {
            badgeClass = "bg-danger";
        }
        else if (Model.rating <= 3)
        {
            badgeClass = "bg-warning text-dark";
        }
    }
}

<section class="nurse-detail-section py-5 bg-light">
    <div class="container">
        <!-- Top Section -->
        <div class="row align-items-start mb-5">
            <!-- Nurse Photo -->
            <div class="col-md-4 text-center mb-4 mb-md-0">
                @{
                    var profilePath = string.IsNullOrEmpty(Model.profilepic)
                    ? "Photos/defaultProfilePic.webp"
                    : $"uploads/nurse/{Model.profilepic}";
                }
                <img src="~/@profilePath"
                     class="rounded-circle shadow nurse-photo" alt="Nurse Photo">
                <div class="mt-3">
                    @if (hasRating)
                    {
                        <span class="badge @badgeClass fs-6">
                            <i class="fas fa-star"></i> @Model.rating
                        </span>
                        <p class="text-muted small mt-1">Based on @Model.reviewsNumber reviews</p>
                    }
                    else
                    {
                        <p class="text-warning fw-bold fs-5">No reviews yet</p>
                    }
                </div>
            </div>

            <!-- Nurse Info Card -->
            <div class="col-md-8">
                <div class="card shadow-sm border-0 rounded-4 p-4">
                    <h2 class="fw-bold text-primary mb-3">
                        <i class="fas fa-user-nurse me-2"></i>@Model.name
                    </h2>
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        <div>
                            <i class="fas fa-envelope text-muted me-2"></i><strong>Email:</strong> @Model.email
                            </div>
                        <div><i class="fas fa-phone text-muted me-2"></i><strong>Phone:</strong> @Model.phone</div>
                        <div><i class="fas fa-map-marker-alt text-muted me-2"></i><strong>Location:</strong> @Model.address</div>
                        <div><i class="fas fa-stethoscope text-muted me-2"></i><strong>Specialty:</strong> @Model.speciality</div>
                        <div><i class="fas fa-graduation-cap text-muted me-2"></i><strong>Degree:</strong> @Model.qualification</div>
                        <div><i class="fas fa-id-badge text-muted me-2"></i><strong>Reg. No:</strong> @Model.license_number</div>
                        <div><i class="fas fa-clock text-muted me-2"></i><strong>Experience:</strong> @Model.experience Years</div>
                    </div>

                    <div class="d-flex gap-3 flex-wrap mt-4">
                        <button class="btn btn-outline-info" onclick="viewFile('@Url.Content("~/uploads/nurse/" + Model.photo_id)')">
                            <i class="fas fa-id-card me-1"></i> View Photo ID
                        </button>

                        <button class="btn btn-outline-success" onclick="viewFile('@Url.Content("~/uploads/nurse/" + Model.license_photo)')">
                            <i class="fas fa-certificate me-1"></i> View License
                        </button>

                        <a asp-controller="Services" asp-action="Booking" asp-route-id="@ViewBag.NurseId" class="btn btn-primary">
                            <i class="fas fa-notes-medical me-1"></i> Book This Nurse
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-5 pt-5 border-top">
            <h4 class="text-center text-primary mb-4"><i class="fas fa-star me-2"></i>Rate and Review This Nurse</h4>

            <div class="row justify-content-center">
                <div class="col-md-8">
                    <form id="reviewForm" asp-action="submitReview" method="post" asp-route-nurseId="@ViewBag.NurseId">
                        <div class="text-center mb-3" id="starRating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="fas fa-star star-select text-secondary fs-3" data-value="@i"></i>
                            }
                        </div>
                        <input type="hidden" id="ratingValue" name="rating" />

                        <div class="mb-3">
                            <input type="text" name="name" id="reviewerName" class="form-control form-control-lg" placeholder="Your Name" required />
                        </div>

                        <div class="mb-3">
                            <textarea id="reviewMessage" name="review_text" class="form-control form-control-lg" placeholder="Your Review" rows="4" required></textarea>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success px-4"><i class="fas fa-paper-plane me-2"></i>Submit Review</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Existing Reviews -->
        <div class="review-section mt-5">
            <h4 class="text-center text-secondary mb-4"><i class="fas fa-comments me-2"></i>User Reviews</h4>
            <div class="row g-4">
                @if (ViewBag.Reviews != null && ((List<BookMyCare.Models.Nurse_Review>)ViewBag.Reviews).Any())
                {
                    foreach (var r in (List<BookMyCare.Models.Nurse_Review>)ViewBag.Reviews)
                    {
                        <div class="col-md-12">
                            <div class="review-box p-4 rounded-4 shadow-sm bg-white h-100">
                                <div class="d-flex justify-content-between mb-2">
                                    <h6 class="mb-0 fw-semibold">@r.name</h6>
                                    <span class="text-warning">
                                        @for (int i = 1; i <= r.rating; i++)
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        @if (r.rating < 5)
                                        {
                                            for (int i = r.rating + 1; i <= 5; i++)
                                            {
                                                <i class="far fa-star text-muted"></i>
                                            }
                                        }
                                    </span>
                                </div>
                                <p class="text-muted mb-0">@r.review_text</p>
                                <p class="text-end text-muted small mt-2">@r.review_date.ToString("dd MMM yyyy")</p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted">
                        No reviews yet. Be the first to review!
                    </div>
                }
            </div>
        </div>

        
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function viewFile(fileUrl) {
            const isPdf = fileUrl.toLowerCase().endsWith(".pdf");

            if (isPdf) {
                Swal.fire({
                    title: 'Document Preview',
                    html: `<iframe src="${fileUrl}" width="100%" height="500px" style="border:none;"></iframe>`,
                    width: 1000,
                    showCloseButton: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    imageUrl: fileUrl,
                    imageWidth: 500,
                    imageAlt: 'Document Image',
                    confirmButtonText: 'Close',
                    customClass: {
                        image: 'rounded shadow'
                    }
                });
            }
        }

             document.querySelectorAll('.star-select').forEach(star => {
            star.addEventListener('click', function () {
                const rating = this.getAttribute('data-value');
                document.getElementById('ratingValue').value = rating;

                // Color stars
                document.querySelectorAll('.star-select').forEach(s => {
                    s.classList.remove('text-warning');
                    s.classList.add('text-secondary');
                });

                for (let i = 0; i < rating; i++) {
                    document.querySelectorAll('.star-select')[i].classList.add('text-warning');
                }
            });
        });
    </script>


    
}

@section Styles {
    <style>
        .nurse-detail-section {
            background: linear-gradient(to right, #e9f2ff, #ffffff);
        }

        .nurse-photo {
            width: 300px;
            height: 300px;
            object-fit: cover;
            border: 5px solid #dee2e6;
            transition: 0.3s;
        }

            .nurse-photo:hover {
                transform: scale(1.05);
                border-color: #0d6efd;
            }

        .btn i {
            transition: transform 0.2s;
        }

        .btn:hover i {
            transform: scale(1.2);
        }

        .review-box {
            transition: 0.3s;
        }

            .review-box:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            }

        .card ul li,
        .card div {
            margin-bottom: 8px;
        }

        .swal2-textarea {
            resize: none;
        }
    </style>
}
